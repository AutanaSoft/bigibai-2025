---
import Button from "@/components/Button.astro"
---

<form id="coupon-form" class="space-y-6">
  <div>
    <label class="sr-only">Código del cupón</label>

    <!-- Input oculto para enviar el valor del formulario -->
    <input type="hidden" id="coupon-value" name="coupon" required />

    <!-- Contenedor de los inputs tipo OTP -->
    <div class="flex items-center justify-center gap-3">
      <!-- Primer grupo: XXXX -->
      <div class="flex gap-2" data-group="0">
        <input
          type="text"
          maxlength="1"
          data-index="0"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
        <input
          type="text"
          maxlength="1"
          data-index="1"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
        <input
          type="text"
          maxlength="1"
          data-index="2"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
        <input
          type="text"
          maxlength="1"
          data-index="3"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
      </div>

      <!-- Separador -->
      <div class="text-brand text-2xl font-bold">-</div>

      <!-- Segundo grupo: XXXX -->
      <div class="flex gap-2" data-group="1">
        <input
          type="text"
          maxlength="1"
          data-index="4"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
        <input
          type="text"
          maxlength="1"
          data-index="5"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
        <input
          type="text"
          maxlength="1"
          data-index="6"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
        <input
          type="text"
          maxlength="1"
          data-index="7"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
      </div>

      <!-- Separador -->
      <div class="text-brand text-2xl font-bold">-</div>

      <!-- Tercer grupo: XXXX -->
      <div class="flex gap-2" data-group="2">
        <input
          type="text"
          maxlength="1"
          data-index="8"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
        <input
          type="text"
          maxlength="1"
          data-index="9"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
        <input
          type="text"
          maxlength="1"
          data-index="10"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
        <input
          type="text"
          maxlength="1"
          data-index="11"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input w-12 h-14 text-center text-2xl font-mono font-bold uppercase bg-black/50 border-2 border-brand/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all"
        />
      </div>
    </div>

    <p class="text-xs text-white/50 mt-4 text-center">
      No hace falta introducir el guión, se añadirá automáticamente
    </p>
  </div>

  <Button type="submit" variant="brand" size="lg" class="w-full">
    Validar cupón
  </Button>
</form>

<script>
  const couponInputs = document.querySelectorAll(
    ".coupon-input"
  ) as NodeListOf<HTMLInputElement>
  const hiddenInput = document.getElementById(
    "coupon-value"
  ) as HTMLInputElement

  // Función para actualizar el valor oculto
  function updateHiddenInput() {
    const values = Array.from(couponInputs).map((input) => input.value)
    const couponValue = `${values.slice(0, 4).join("")}-${values.slice(4, 8).join("")}-${values.slice(8, 12).join("")}`
    hiddenInput.value = couponValue
  }

  // Manejar input en cada caja
  couponInputs.forEach((input, index) => {
    input.addEventListener("input", (e) => {
      const target = e.target as HTMLInputElement
      let value = target.value.toUpperCase().replace(/[^A-Z0-9]/g, "")

      // Solo permitir un carácter
      if (value.length > 1) {
        value = value[0]
      }

      target.value = value

      // Si se ingresó un carácter, mover al siguiente input
      if (value && index < couponInputs.length - 1) {
        couponInputs[index + 1].focus()
      }

      updateHiddenInput()
    })

    // Manejar backspace
    input.addEventListener("keydown", (e) => {
      const target = e.target as HTMLInputElement

      if (e.key === "Backspace" && !target.value && index > 0) {
        couponInputs[index - 1].focus()
      }
    })

    // Manejar paste
    input.addEventListener("paste", (e) => {
      e.preventDefault()
      const pastedData = e.clipboardData?.getData("text") || ""
      const cleaned = pastedData.toUpperCase().replace(/[^A-Z0-9]/g, "")

      // Distribuir los caracteres pegados en los inputs
      cleaned.split("").forEach((char, i) => {
        const targetIndex = index + i
        if (targetIndex < couponInputs.length) {
          couponInputs[targetIndex].value = char
        }
      })

      // Mover el foco al siguiente input disponible
      const nextIndex = Math.min(
        index + cleaned.length,
        couponInputs.length - 1
      )
      couponInputs[nextIndex].focus()

      updateHiddenInput()
    })
  })

  // Focus en el primer input al cargar
  if (couponInputs.length > 0) {
    couponInputs[0].focus()
  }
</script>

<style>
  .coupon-input:focus {
    transform: scale(1.05);
  }

  .coupon-input::placeholder {
    color: rgba(248, 177, 52, 0.3);
  }
</style>
